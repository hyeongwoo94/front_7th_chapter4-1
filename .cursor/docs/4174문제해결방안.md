# 4174 포트 문제 해결 방안

## 문제 현상

- 테스트가 하나도 통과하지 않음
- HTML에 `<!--app-html-->` 플레이스홀더만 표시됨
- SSR 렌더링이 작동하지 않음

## 원인 분석

### 가능한 원인들

1. **빌드 문제**
   - 서버 빌드가 안 되어 있음
   - 클라이언트 빌드가 안 되어 있음

2. **URL 전달 문제**
   - `req.originalUrl`이 제대로 전달되지 않음
   - Base 경로가 제대로 처리되지 않음

3. **라우트 매칭 실패**
   - `matchRoute` 함수가 baseUrl을 제대로 제거하지 못함
   - 라우트 핸들러가 매칭되지 않음

4. **렌더링 함수 실행 실패**
   - `render` 함수가 빈 HTML을 반환
   - 에러가 발생했지만 처리되지 않음

5. **HTML 템플릿 치환 실패**
   - `appHtml`이 undefined 또는 빈 문자열
   - 템플릿 치환이 제대로 작동하지 않음

## 해결 방법

### 1단계: 디버깅 로그 추가 (현재 진행 중)

**server.js에 추가:**

- URL 처리 확인 로그
- render 함수 호출 결과 확인 로그
- appHtml 상태 확인 로그

**main-server.js에 추가:**

- URL 및 baseUrl 확인 로그
- 라우트 매칭 결과 확인 로그
- 렌더링 전 상태 확인 로그
- pageHtml 생성 결과 확인 로그

**확인 사항:**

1. `req.originalUrl` 값이 무엇인지
2. `url to render` 값이 무엇인지
3. `baseUrl` 값이 무엇인지
4. `route.handler`가 무엇인지
5. `pageHtml length`가 0인지
6. `appHtml length`가 0인지

### 2단계: 서버 재시작 및 로그 확인

```bash
cd packages/vanilla
pnpm run build:server
pnpm run preview:ssr
```

브라우저에서 접속 후 서버 콘솔의 로그 확인:

- `[SSR 4174 Debug]`로 시작하는 로그
- `[Render 4174 Debug]`로 시작하는 로그

### 3단계: 문제별 해결 방법

#### 문제 1: 빌드가 안 되어 있을 때

```bash
cd packages/vanilla
pnpm run build:without-ssg
```

#### 문제 2: URL이 제대로 전달되지 않을 때

- `req.originalUrl` 대신 `req.url` 사용 시도
- Base 경로가 포함된 전체 URL을 전달하는지 확인

#### 문제 3: 라우트 매칭 실패

- `matchRoute` 함수에서 baseUrl 제거 로직 확인
- URL이 `/front_7th_chapter4-1/vanilla/`로 시작하는지 확인

#### 문제 4: pageHtml이 비어있을 때

- 라우트 핸들러가 제대로 매칭되었는지 확인
- 데이터 프리페칭이 성공했는지 확인
- 렌더링 로직이 실행되었는지 확인

#### 문제 5: HTML 템플릿 치환 실패

- `appHtml`이 undefined인지 확인
- 기본값(`'<div id="root"></div>'`)이 사용되는지 확인

### 4단계: 대안 방법 시도

#### 방법 1: Base 경로 제거 로직 개선

```javascript
// main-server.js에서
const baseUrl = process.env.NODE_ENV === "production" ? "/front_7th_chapter4-1/vanilla/" : "";

// matchRoute에서 baseUrl 제거 로직 강화
function matchRoute(url, baseUrl) {
  let pathname = url;
  if (baseUrl && pathname.startsWith(baseUrl)) {
    pathname = pathname.slice(baseUrl.length);
  }
  // ... 나머지 로직
}
```

#### 방법 2: URL 정규화

```javascript
// server.js에서
const url = req.originalUrl?.split("?")[0] || req.url.split("?")[0];
// Base 경로 정규화
const normalizedUrl = url.endsWith("/") ? url : url + "/";
```

#### 방법 3: 에러 처리 개선

```javascript
// render 함수에서 에러 발생 시에도 기본 HTML 반환
catch (error) {
  console.error("서버 렌더링 오류:", error);
  return {
    html: '<div class="p-4 text-red-600">서버 렌더링 중 오류가 발생했습니다.</div>',
    initialState: {},
    title: "서버 오류 - 쇼핑몰",
  };
}
```

#### 방법 4: 강제 기본값 설정

```javascript
// server.js에서
const html = template
  .replace("<!--app-html-->", appHtml && appHtml.trim().length > 0 ? appHtml : '<div id="root"><p>로딩 중...</p></div>')
  .replace("<!--app-head-->", initialStateScript)
  .replace("<!--app-title-->", title);
```

## 실행 순서

1. 디버깅 로그 추가 완료
2. 서버 빌드 실행
3. 프로덕션 서버 실행
4. 브라우저에서 접속
5. 서버 콘솔 로그 확인
6. 로그 분석 후 문제점 파악
7. 문제점에 맞는 해결 방법 적용
8. 재시도

## 확인 체크리스트

- [ ] 빌드가 완료되었는가? (`dist/vanilla-ssr/main-server.js` 존재)
- [ ] 서버가 정상적으로 시작되었는가?
- [ ] URL이 제대로 전달되는가? (`req.originalUrl` 확인)
- [ ] 라우트가 매칭되는가? (`route.handler` 확인)
- [ ] 데이터가 로드되는가? (`totalCount` 확인)
- [ ] pageHtml이 생성되는가? (`pageHtml length` 확인)
- [ ] appHtml이 전달되는가? (`appHtml length` 확인)

## 다음 단계

로그를 확인한 후 구체적인 문제점을 파악하고, 해당 문제에 맞는 해결 방법을 적용합니다.
