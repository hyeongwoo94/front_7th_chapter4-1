# SSR/SSG 프로젝트 작업 체크리스트

## 프로젝트 개요

본 문서는 Vanilla JavaScript와 React를 사용하여 Server-Side Rendering(SSR)과 Static Site Generation(SSG)을 구현한 작업 내용을 체크리스트 형태로 정리한 문서입니다.

**작성일**: 2025년 1월  
**프로젝트**: front_7th_chapter4-1  
**작업 범위**: 기본과제 (Vanilla SSR & SSG)

---

## 기본과제: Vanilla SSR & SSG

### 1. Express SSR 서버

#### 1.1 Express 미들웨어 기반 서버 구현
- [x] Express 서버 기본 구조 구현 (`packages/vanilla/server.js`)
- [x] Express 정적 파일 서빙 설정 (`express.static` / `sirv`)
- [x] 개발 환경: 소스 파일 직접 서빙 (`/src`, `/public`)
- [x] 프로덕션 환경: 빌드된 정적 파일 서빙 (`dist/vanilla`)
- [x] HTML 템플릿 파일 읽기 및 처리 (`index.html`)
- [x] SSR 렌더링 함수 비동기 초기화 (`initializeRender()`)
- [x] 개발/프로덕션 환경별 모듈 import 분기 처리

**구현 파일**: `packages/vanilla/server.js`

**주요 구현 내용**:
- Express 앱 생성 및 미들웨어 설정
- 정적 파일 서빙 (sirv 사용)
- SSR 렌더링 미들웨어 구현
- API 요청 직접 처리 미들웨어 (`/products`, `/products/:id`, `/categories`)

#### 1.2 개발/프로덕션 환경 분기 처리
- [x] `NODE_ENV` 환경 변수를 기반으로 분기 로직 구현
- [x] 개발 환경: 소스 파일 직접 import (`./src/main-server.js`)
- [x] 프로덕션 환경: 빌드된 서버 모듈 사용 (`./dist/vanilla-ssr/main-server.js`)
- [x] 개발 환경: 정적 파일 소스 디렉토리 서빙
- [x] 프로덕션 환경: 빌드된 정적 파일 서빙
- [x] 환경별 포트 및 base URL 설정

**구현 내용**:
```javascript
const prod = process.env.NODE_ENV === "production";
const port = process.env.PORT || 5174;
const base = process.env.BASE || (prod ? "/front_7th_chapter4-1/vanilla/" : "/");
```

#### 1.3 HTML 템플릿 치환
- [x] `index.html` 파일 읽기
- [x] `<!--app-html-->` 플레이스홀더를 서버 렌더링된 HTML로 치환
- [x] `<!--app-head-->` 플레이스홀더를 `window.__INITIAL_DATA__` 스크립트로 치환
- [x] `<!--app-title-->` 플레이스홀더를 동적 페이지 타이틀로 치환
- [x] Content-Type, Content-Length, Connection 헤더 설정 (JavaScript 비활성화 환경 대응)

**구현 내용**:
```javascript
const html = template
  .replace("<!--app-html-->", appHtml || '<div id="root"></div>')
  .replace("<!--app-head-->", initialStateScript)
  .replace("<!--app-title-->", title);
```

---

### 2. 서버 사이드 렌더링 (SSR)

#### 2.1 서버에서 동작하는 Router 구현
- [x] 서버 사이드에서 동작하는 Router 구현 (`matchRoute()` 함수)
- [x] URL 경로 파싱 및 라우트 매칭
- [x] 동적 라우트 파라미터 추출 (`/product/:id/`)
- [x] baseUrl 처리 로직 구현
- [x] 쿼리 파라미터 분리 처리
- [x] 404 라우트 처리

**구현 파일**: `packages/vanilla/src/main-server.js`

**주요 구현 내용**:
- `matchRoute(url, baseUrl)` 함수로 서버 사이드 라우트 매칭
- 홈페이지 (`/`), 상품 상세 페이지 (`/product/:id/`), 404 페이지 처리
- 클라이언트 Router와 동일한 라우트 구조 유지

#### 2.2 서버 데이터 프리페칭
- [x] 홈페이지 (`/`): 상품 목록 데이터 프리페칭
- [x] 홈페이지: 카테고리 데이터 프리페칭
- [x] 상품 상세 페이지 (`/product/:id/`): 상품 상세 데이터 프리페칭
- [x] 상품 상세 페이지: 관련 상품 데이터 프리페칭
- [x] 쿼리 파라미터 기반 필터링 (검색, 카테고리, 정렬, 페이지네이션)
- [x] API 호출을 서버 사이드에서 수행
- [x] 에러 처리 및 기본값 설정

**구현 파일**: `packages/vanilla/src/main-server.js`

**주요 구현 내용**:
- `getProducts()`, `getProduct()` API 함수를 사용한 데이터 프리페칭
- `productStore.dispatch()`를 통한 서버 사이드 상태 초기화
- 필터링, 정렬, 페이지네이션 로직 적용
- 에러 발생 시에도 기본 상태로 렌더링 가능하도록 처리

#### 2.3 서버 상태관리 초기화
- [x] 서버 사이드에서 Store 초기화
- [x] 프리페칭한 데이터로 Store 상태 설정
- [x] 초기화된 상태를 `initialState` 객체로 추출
- [x] `productStore`, `cartStore`, `uiStore` 상태 포함
- [x] 각 요청마다 깨끗한 상태로 시작

**구현 파일**: `packages/vanilla/src/main-server.js`

**주요 구현 내용**:
```javascript
// 스토어 초기화
productStore.dispatch({
  type: PRODUCT_ACTIONS.SETUP,
  payload: { ...initialProductState },
});

// 데이터 프리페칭 후 상태 업데이트
productStore.dispatch({
  type: PRODUCT_ACTIONS.SETUP,
  payload: { products, categories, totalCount, ... },
});

// initialState 추출
const initialState = {
  productStore: productStore.getState(),
  cartStore: cartStore.getState(),
  uiStore: uiStore.getState(),
};
```

---

### 3. 클라이언트 Hydration

#### 3.1 `window.__INITIAL_DATA__` 스크립트 주입
- [x] 서버에서 생성한 초기 상태를 `window.__INITIAL_DATA__`에 주입
- [x] HTML 템플릿에 스크립트 태그로 포함
- [x] JSON.stringify를 통한 안전한 직렬화
- [x] `<!--app-head-->` 플레이스홀더에 삽입

**구현 파일**: `packages/vanilla/server.js`

**구현 내용**:
```javascript
const initialStateScript = `<script>window.__INITIAL_DATA__ = ${JSON.stringify(initialState || {})};</script>`;
const html = template.replace("<!--app-head-->", initialStateScript);
```

#### 3.2 클라이언트 상태 복원
- [x] `main.js`에서 `window.__INITIAL_DATA__` 읽기
- [x] 읽은 데이터로 Store 초기화 (`hydrateStores()` 함수)
- [x] `productStore` 상태 복원
- [x] `cartStore`는 localStorage 우선 처리
- [x] `uiStore`는 클라이언트 전용으로 서버 상태 무시
- [x] Hydration 모드로 렌더링 시작

**구현 파일**: `packages/vanilla/src/main.js`

**주요 구현 내용**:
```javascript
function hydrateStores() {
  const initialState = window.__INITIAL_DATA__ || {};
  
  if (initialState.productStore) {
    productStore.dispatch({
      type: PRODUCT_ACTIONS.SETUP,
      payload: initialState.productStore,
    });
  }
  
  // cartStore는 localStorage 우선
  // uiStore는 클라이언트 전용
}
```

#### 3.3 서버-클라이언트 데이터 일치
- [x] 서버에서 렌더링한 HTML과 클라이언트에서 렌더링한 HTML 일치 확인
- [x] Hydration 불일치 오류 방지
- [x] 서버와 클라이언트에서 동일한 초기 상태 사용
- [x] 렌더링 로직 일관성 유지
- [x] 디버깅 로그를 통한 데이터 일치 확인

**구현 내용**:
- 서버와 클라이언트에서 동일한 Store 초기화 로직 사용
- 서버에서 프리페칭한 데이터를 클라이언트에서 그대로 사용
- Hydration 시 서버-클라이언트 데이터 일치 여부 로그 출력

---

### 4. Static Site Generation (SSG)

#### 4.1 동적 라우트 SSG
- [x] 상품 상세 페이지들을 빌드 타임에 미리 생성
- [x] 모든 상품 ID에 대해 정적 HTML 파일 생성
- [x] 홈페이지도 SSG로 생성
- [x] 404 페이지 생성
- [x] 파일 시스템 기반 페이지 생성

**구현 파일**: `packages/vanilla/static-site-generate.js`

**주요 구현 내용**:
```javascript
// 홈페이지 생성
const homeResult = await render("/", {});
fs.writeFileSync(path.join(outputDir, "index.html"), homeHtml);

// 모든 상품 상세 페이지 생성
for (const item of items) {
  const productResult = await render(`/product/${item.productId}/`, {});
  const productDir = path.join(outputDir, "product", item.productId);
  fs.mkdirSync(productDir, { recursive: true });
  fs.writeFileSync(path.join(productDir, "index.html"), productHtml);
}
```

#### 4.2 빌드 타임 페이지 생성
- [x] `package.json`에 SSG 빌드 스크립트 추가
- [x] 빌드 프로세스: 클라이언트 빌드 → SSG 생성
- [x] MSW 서버 초기화 (SSG 빌드 타임에 fetch intercept)
- [x] HTML 템플릿 주입 유틸리티 사용 (`injectIntoTemplate`)
- [x] 빌드 로그 및 진행 상황 출력

**구현 파일**: 
- `packages/vanilla/static-site-generate.js`
- `packages/vanilla/package.json`

**빌드 스크립트**:
```json
{
  "scripts": {
    "build:client-for-ssg": "vite build --outDir ../../dist/vanilla",
    "build:ssg": "pnpm run build:client-for-ssg && node static-site-generate.js",
    "build": "pnpm run build:client && pnpm run build:server && pnpm run build:ssg"
  }
}
```

#### 4.3 파일 시스템 기반 배포
- [x] 생성된 정적 파일들을 `dist/vanilla` 디렉토리에 배치
- [x] GitHub Pages 등 정적 호스팅에 배포 가능하도록 구성
- [x] 디렉토리 구조 생성 (`product/:id/index.html`)
- [x] 404 페이지 복사

**디렉토리 구조**:
```
dist/vanilla/
├── index.html (홈페이지)
├── 404.html
├── product/
│   ├── 85067212996/
│   │   └── index.html
│   ├── 86940857379/
│   │   └── index.html
│   └── ...
└── assets/ (빌드된 JS/CSS)
```

---

## 추가 구현 사항

### 5. 유틸리티 함수 및 리팩토링

#### 5.1 공통 유틸리티 함수
- [x] `productFilter.js`: 상품 필터링 로직 공통화
- [x] `titleUtils.js`: 페이지 타이틀 생성 로직 공통화
- [x] `htmlUtils.js`: HTML 템플릿 주입 로직 공통화
- [x] SSR/SSG에서 공통 유틸리티 사용

**구현 파일**:
- `packages/vanilla/src/utils/productFilter.js`
- `packages/vanilla/src/utils/titleUtils.js`
- `packages/vanilla/src/utils/htmlUtils.js`

#### 5.2 동적 페이지 타이틀
- [x] 홈페이지: "쇼핑몰 - 홈"
- [x] 상품 상세 페이지: "{상품명} - 쇼핑몰"
- [x] 404 페이지: "페이지를 찾을 수 없습니다 - 쇼핑몰"
- [x] 서버 사이드에서 타이틀 동적 생성
- [x] HTML `<title>` 태그에 주입

**구현 파일**: `packages/vanilla/src/utils/titleUtils.js`

#### 5.3 에러 처리 및 로깅
- [x] 서버 렌더링 중 에러 처리
- [x] 데이터 프리페칭 실패 시 기본값 설정
- [x] 상세한 디버깅 로그 출력
- [x] 에러 발생 시 사용자 친화적 메시지 표시

---

## 테스트 및 검증

### 6. E2E 테스트

**테스트 실행 환경** (`e2e/e2e-basic.spec.ts`):
- CSR 테스트: `http://localhost:5173/` (개발), `http://localhost:4173/front_7th_chapter4-1/vanilla/` (프로덕션)
- SSR 테스트: `http://localhost:5174/` (개발), `http://localhost:4174/front_7th_chapter4-1/vanilla/` (프로덕션)
- SSG 테스트: `http://localhost:4178/front_7th_chapter4-1/vanilla/` (프로덕션)

#### 6.1 CSR 테스트
- [x] CSR E2E 테스트 구현 (`e2e/createTests.ts`)
- [x] 기본 기능 테스트
  - "페이지 접속 시 로딩 상태가 표시되고 상품 목록이 정상적으로 로드된다"
  - "상품 카드에 기본 정보가 올바르게 표시된다"
- [x] 검색 및 필터링 기능 테스트
  - "검색어 입력 후 Enter 키로 검색하고 URL이 업데이트된다"
  - "카테고리 선택 후 브레드크럼과 URL이 업데이트된다"
  - "브레드크럼 클릭으로 상위 카테고리로 이동할 수 있다"
  - "정렬 옵션 변경 시 URL이 업데이트된다"
  - "페이지당 상품 수 변경 시 URL이 업데이트된다"
- [x] 상태 관리 및 URL 복원 테스트
  - "검색어와 필터 조건이 URL에서 복원된다"
  - "장바구니 내용이 localStorage에 저장되고 복원된다"
  - "장바구니 아이콘에 상품 개수가 정확히 표시된다"
- [x] 상품 상세 페이지 테스트
  - "상품 클릭부터 관련 상품 이동까지 전체 플로우"
- [x] 장바구니 기능 테스트
  - "여러 상품 추가, 수량 조절, 선택 삭제 전체 시나리오"
  - "전체 선택 후 장바구니 비우기"
- [x] 무한 스크롤 테스트
  - "페이지 하단 스크롤 시 추가 상품이 로드된다"
- [x] 모달 및 UI 인터랙션 테스트
  - "장바구니 모달이 다양한 방법으로 열리고 닫힌다"
  - "토스트 메시지 시스템이 올바르게 작동한다"
- [x] SPA 네비게이션 테스트
  - "브라우저 뒤로가기/앞으로가기가 올바르게 작동한다"
  - "존재하지 않는 페이지 접근 시 404 페이지가 표시된다"

#### 6.2 SSR 테스트
- [x] SSR 초기 렌더링 검증 테스트
  - "SSR로 렌더링된 페이지가 서버에서 완전한 HTML을 제공한다" (JavaScript 비활성화 환경)
  - "SSR에서 초기 데이터가 window.__INITIAL_DATA__에 포함된다"
- [x] 검색 및 필터링 SSR 테스트
  - "검색 파라미터가 포함된 URL이 SSR로 올바르게 렌더링된다"
  - "카테고리 필터링이 SSR로 올바르게 렌더링된다"
  - "복합 필터링(검색+카테고리+정렬)이 SSR로 올바르게 렌더링된다"
- [x] 상품 상세 페이지 SSR 테스트
  - "상품 상세 페이지가 SSR로 올바르게 렌더링된다"
- [x] SEO 및 메타데이터 테스트
  - "SSR 페이지에 적절한 메타태그가 포함된다"
  - "상품 상세 페이지에 동적 메타태그가 설정된다"
- [x] JavaScript 비활성화 환경 테스트 (모든 SSR 테스트에서 `javaScriptEnabled: false` 사용)

#### 6.3 SSG 테스트
- [x] SSG 초기 렌더링 검증 테스트
  - "SSG로 렌더링된 페이지가 서버에서 완전한 HTML을 제공한다" (JavaScript 비활성화 환경)
  - "SSG에서 초기 데이터가 window.__INITIAL_DATA__에 포함된다"
- [x] 상품 상세 페이지 SSG 테스트
  - "상품 상세 페이지가 SSR로 올바르게 렌더링된다" (SSG 빌드된 정적 파일)
- [x] SEO 및 메타데이터 테스트
  - "SSG 페이지에 적절한 메타태그가 포함된다"
  - "상품 상세 페이지에 동적 메타태그가 설정된다"
- [ ] **누락됨**: SSG 검색 및 필터링 테스트 (테스트 코드에 없음)

**참고**: 테스트 코드에서 SSG 테스트 섹션 이름이 "SSR"로 표기되어 있으나, 실제로는 SSG 테스트입니다.

**테스트 파일**: `e2e/e2e-basic.spec.ts`, `e2e/createTests.ts`

---

## 빌드 및 배포

### 7. 빌드 스크립트

#### 7.1 개발 스크립트
- [x] `dev`: CSR 개발 서버 (포트 5173)
- [x] `dev:ssr`: SSR 개발 서버 (포트 5174)
- [x] `preview:csr`: CSR 프로덕션 미리보기
- [x] `preview:ssr`: SSR 프로덕션 미리보기
- [x] `preview:ssg`: SSG 프로덕션 미리보기

#### 7.2 빌드 스크립트
- [x] `build:client`: 클라이언트 빌드
- [x] `build:server`: 서버 빌드 (SSR 모듈)
- [x] `build:ssg`: SSG 빌드
- [x] `build`: 전체 빌드 (클라이언트 + 서버 + SSG)
- [x] `serve:test`: 테스트용 서버 실행 (모든 환경 동시 실행)

**구현 파일**: `packages/vanilla/package.json`

---

## 기술 스택 및 도구

### 8. 사용 기술

#### 8.1 핵심 기술
- [x] **Express.js**: SSR 서버 프레임워크
- [x] **Vite**: 빌드 도구 및 개발 서버
- [x] **Vanilla JavaScript**: 프레임워크 없는 순수 JavaScript
- [x] **MSW (Mock Service Worker)**: API 모킹

#### 8.2 상태 관리
- [x] **Redux-style Store**: `createStore`를 통한 중앙 집중식 상태 관리
- [x] **Observer 패턴**: 상태 변경 시 자동 UI 업데이트
- [x] **Store 구조**: `productStore`, `cartStore`, `uiStore`

#### 8.3 라우팅
- [x] **SPA Router**: 바닐라 JS로 구현된 클라이언트사이드 라우팅
- [x] **서버 Router**: SSR을 위한 서버 사이드 라우팅
- [x] **Universal Router**: 서버/클라이언트 공통 라우트 구조

---

## 완료 상태 요약

### 기본과제 (Vanilla SSR & SSG)

#### Express SSR 서버
- ✅ Express 미들웨어 기반 서버 구현
- ✅ 개발/프로덕션 환경 분기 처리
- ✅ HTML 템플릿 치환 (`<!--app-html-->`, `<!--app-head-->`, `<!--app-title-->`)

#### 서버 사이드 렌더링
- ✅ 서버에서 동작하는 Router 구현
- ✅ 서버 데이터 프리페칭 (상품 목록, 상품 상세)
- ✅ 서버 상태관리 초기화

#### 클라이언트 Hydration
- ✅ `window.__INITIAL_DATA__` 스크립트 주입
- ✅ 클라이언트 상태 복원
- ✅ 서버-클라이언트 데이터 일치

#### Static Site Generation
- ✅ 동적 라우트 SSG (상품 상세 페이지들)
- ✅ 빌드 타임 페이지 생성
- ✅ 파일 시스템 기반 배포

---

## 테스트 코드 기준 검증 사항

### 테스트 코드와 체크리스트 비교 결과

#### ✅ 일치하는 항목
- 모든 SSR 테스트 항목이 체크리스트와 일치
- 모든 CSR 테스트 항목이 체크리스트와 일치
- SSG 기본 테스트 항목이 체크리스트와 일치

#### ⚠️ 주의사항
1. **SSG 테스트에 검색 및 필터링 테스트 없음**
   - 테스트 코드(`createSSGTest`)에는 검색 및 필터링 테스트가 없습니다
   - SSR 테스트에는 있지만 SSG 테스트에는 없음
   - 체크리스트에 "SSG 검색 및 필터링 테스트" 항목이 있다면 제거해야 함

2. **테스트 코드 섹션 이름 불일치**
   - `createSSGTest` 내부의 섹션 이름이 "SSR 초기 렌더링 검증", "SSR 상품 상세 페이지", "SSR SEO 및 메타데이터"로 되어 있음
   - 실제로는 SSG 테스트이지만 섹션 이름이 SSR로 표기됨
   - 테스트 코드의 문제이지만, 체크리스트에서는 SSG로 명확히 구분

3. **테스트 실행 환경**
   - CSR: 개발(5173), 프로덕션(4173) 두 환경 모두 테스트
   - SSR: 개발(5174), 프로덕션(4174) 두 환경 모두 테스트
   - SSG: 프로덕션(4178)만 테스트

---

## 향후 개선 사항

### 9. 개선 가능 영역

#### 9.1 성능 최적화
- [ ] 대용량 데이터(1000개 이상 상품) 처리 시 메모리 사용량 최적화
- [ ] SSG 빌드 시간 최적화
- [ ] 서버 렌더링 응답 시간 최적화
- [ ] 코드 스플리팅 및 지연 로딩

#### 9.2 에러 처리 강화
- [ ] 서버 렌더링 중 에러 발생 시 더 상세한 에러 페이지
- [ ] SSG 빌드 중 에러 처리 개선
- [ ] 네트워크 오류 시 재시도 로직

#### 9.3 테스트 커버리지 향상
- [ ] 단위 테스트 추가
- [ ] 통합 테스트 추가
- [ ] 성능 테스트 추가

---

## 참고 자료

- Express.js 공식 문서
- Vite SSR 가이드
- Playwright E2E 테스트 가이드
- MSW (Mock Service Worker) 문서

---

**작성자**: AI Assistant  
**최종 업데이트**: 2025년 1월

